"""
Dashboard API + Token Updater ‚Äî Single file, no 404 issues.
"""

from flask import Flask, jsonify, Response, request
import sqlite3, os, json, pathlib, base64

BASE_DIR = pathlib.Path(__file__).parent.resolve()
app     = Flask(__name__)
DB_FILE = str(BASE_DIR / "trading.db")
STATE_F = str(BASE_DIR / "bot_state.json")

RAILWAY_TOKEN      = os.getenv("RAILWAY_TOKEN", "")
RAILWAY_PROJECT_ID = os.getenv("RAILWAY_PROJECT_ID", "")

# Dashboard HTML embedded as base64
_HTML_B64 = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9IlVURi04Ii8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIi8+Cjx0aXRsZT5OSUZUWSBCT1Qg4oCUIFRyYWRpbmcgRGFzaGJvYXJkPC90aXRsZT4KPGxpbmsgaHJlZj0iaHR0cHM6Ly9mb250cy5nb29nbGVhcGlzLmNvbS9jc3MyP2ZhbWlseT1TeW5lOndnaHRANDAwOzYwMDs3MDA7ODAwJmZhbWlseT1KZXRCcmFpbnMrTW9ubzp3Z2h0QDMwMDs0MDA7NTAwOzYwMCZkaXNwbGF5PXN3YXAiIHJlbD0ic3R5bGVzaGVldCIvPgo8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvQ2hhcnQuanMvNC40LjEvY2hhcnQudW1kLm1pbi5qcyI+PC9zY3JpcHQ+CjxzdHlsZT4KICA6cm9vdCB7CiAgICAtLWJnOiAgICAgICAjMDgwYzE0OwogICAgLS1zdXJmYWNlOiAgIzBkMTQyMDsKICAgIC0tY2FyZDogICAgICMxMTE4Mjc7CiAgICAtLWJvcmRlcjogICAjMWUyZDQ1OwogICAgLS1hY2NlbnQ6ICAgIzAwZDRmZjsKICAgIC0tZ3JlZW46ICAgICMwMGU2NzY7CiAgICAtLXJlZDogICAgICAjZmYzZDZiOwogICAgLS1nb2xkOiAgICAgI2ZmZDc2MDsKICAgIC0tcHVycGxlOiAgICNjMDg0ZmM7CiAgICAtLXRleHQ6ICAgICAjZTJlOGYwOwogICAgLS1tdXRlZDogICAgIzY0NzQ4YjsKICAgIC0tZ2xvdzogICAgIDAgMCAzMHB4IHJnYmEoMCwyMTIsMjU1LDAuMTIpOwogIH0KCiAgKiB7IG1hcmdpbjowOyBwYWRkaW5nOjA7IGJveC1zaXppbmc6Ym9yZGVyLWJveDsgfQoKICBib2R5IHsKICAgIGJhY2tncm91bmQ6IHZhcigtLWJnKTsKICAgIGNvbG9yOiB2YXIoLS10ZXh0KTsKICAgIGZvbnQtZmFtaWx5OiAnSmV0QnJhaW5zIE1vbm8nLCBtb25vc3BhY2U7CiAgICBtaW4taGVpZ2h0OiAxMDB2aDsKICAgIG92ZXJmbG93LXg6IGhpZGRlbjsKICB9CgogIC8qIOKUgOKUgCBBbmltYXRlZCBiYWNrZ3JvdW5kIGdyaWQg4pSA4pSAICovCiAgYm9keTo6YmVmb3JlIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGZpeGVkOwogICAgaW5zZXQ6IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOgogICAgICBsaW5lYXItZ3JhZGllbnQocmdiYSgwLDIxMiwyNTUsMC4wMykgMXB4LCB0cmFuc3BhcmVudCAxcHgpLAogICAgICBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHJnYmEoMCwyMTIsMjU1LDAuMDMpIDFweCwgdHJhbnNwYXJlbnQgMXB4KTsKICAgIGJhY2tncm91bmQtc2l6ZTogNDBweCA0MHB4OwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAwOwogIH0KCiAgYm9keTo6YWZ0ZXIgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICB0b3A6IC00MCU7CiAgICBsZWZ0OiAtMjAlOwogICAgd2lkdGg6IDYwMHB4OwogICAgaGVpZ2h0OiA2MDBweDsKICAgIGJhY2tncm91bmQ6IHJhZGlhbC1ncmFkaWVudChjaXJjbGUsIHJnYmEoMCwyMTIsMjU1LDAuMDYpIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAwOwogICAgYW5pbWF0aW9uOiBvcmIgMTJzIGVhc2UtaW4tb3V0IGluZmluaXRlIGFsdGVybmF0ZTsKICB9CgogIEBrZXlmcmFtZXMgb3JiIHsKICAgIDAlICAgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgwLDApOyB9CiAgICAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMjAwcHgsIDEwMHB4KTsgfQogIH0KCiAgLyog4pSA4pSAIEhlYWRlciDilIDilIAgKi8KICBoZWFkZXIgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgei1pbmRleDogMTA7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgIHBhZGRpbmc6IDIycHggMzZweDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgYmFja2dyb3VuZDogcmdiYSg4LDEyLDIwLDAuODUpOwogICAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEycHgpOwogIH0KCiAgLmxvZ28gewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDE0cHg7CiAgfQoKICAubG9nby1pY29uIHsKICAgIHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDM4cHg7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCB2YXIoLS1hY2NlbnQpLCAjMDA2NmZmKTsKICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMThweDsKICAgIGJveC1zaGFkb3c6IDAgMCAyMHB4IHJnYmEoMCwyMTIsMjU1LDAuMyk7CiAgfQoKICAubG9nby10ZXh0IHsKICAgIGZvbnQtZmFtaWx5OiAnU3luZScsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBmb250LXdlaWdodDogODAwOwogICAgbGV0dGVyLXNwYWNpbmc6IDAuNXB4OwogIH0KCiAgLmxvZ28tdGV4dCBzcGFuIHsgY29sb3I6IHZhcigtLWFjY2VudCk7IH0KCiAgLmhlYWRlci1yaWdodCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGdhcDogMjBweDsKICB9CgogIC5saXZlLWJhZGdlIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgZ2FwOiA4cHg7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMjMwLDExOCwwLjEpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLDIzMCwxMTgsMC4yNSk7CiAgICBib3JkZXItcmFkaXVzOiAyMHB4OwogICAgcGFkZGluZzogNnB4IDE0cHg7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBjb2xvcjogdmFyKC0tZ3JlZW4pOwogICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgfQoKICAubGl2ZS1kb3QgewogICAgd2lkdGg6IDdweDsgaGVpZ2h0OiA3cHg7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1ncmVlbik7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBhbmltYXRpb246IHB1bHNlIDJzIGluZmluaXRlOwogIH0KCiAgQGtleWZyYW1lcyBwdWxzZSB7CiAgICAwJSwgMTAwJSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0KICAgIDUwJSAgICAgICB7IG9wYWNpdHk6IDAuNDsgdHJhbnNmb3JtOiBzY2FsZSgwLjgpOyB9CiAgfQoKICAubGFzdC11cGRhdGUgewogICAgZm9udC1zaXplOiAxMXB4OwogICAgY29sb3I6IHZhcigtLW11dGVkKTsKICB9CgogIC8qIOKUgOKUgCBNYWluIGxheW91dCDilIDilIAgKi8KICBtYWluIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHotaW5kZXg6IDU7CiAgICBwYWRkaW5nOiAyOHB4IDM2cHg7CiAgICBtYXgtd2lkdGg6IDE2MDBweDsKICAgIG1hcmdpbjogMCBhdXRvOwogIH0KCiAgLyog4pSA4pSAIEtQSSBDYXJkcyDilIDilIAgKi8KICAua3BpLWdyaWQgewogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDYsIDFmcik7CiAgICBnYXA6IDE0cHg7CiAgICBtYXJnaW4tYm90dG9tOiAyNHB4OwogIH0KCiAgQG1lZGlhIChtYXgtd2lkdGg6IDEyMDBweCkgeyAua3BpLWdyaWQgeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgzLDFmcik7IH0gfQogIEBtZWRpYSAobWF4LXdpZHRoOiA3MDBweCkgIHsgLmtwaS1ncmlkIHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMiwxZnIpOyB9IH0KCiAgLmtwaSB7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1jYXJkKTsKICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICBib3JkZXItcmFkaXVzOiAxNHB4OwogICAgcGFkZGluZzogMjBweCAxOHB4OwogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjJzLCBib3gtc2hhZG93IDAuMnM7CiAgICBhbmltYXRpb246IGZhZGVVcCAwLjVzIGVhc2UgYm90aDsKICB9CgogIC5rcGk6aG92ZXIgewogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0ycHgpOwogICAgYm94LXNoYWRvdzogdmFyKC0tZ2xvdyk7CiAgICBib3JkZXItY29sb3I6IHJnYmEoMCwyMTIsMjU1LDAuMik7CiAgfQoKICAua3BpOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOwogICAgaGVpZ2h0OiAycHg7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1hY2NlbnQtY29sb3IsIHZhcigtLWFjY2VudCkpOwogICAgb3BhY2l0eTogMC43OwogIH0KCiAgLmtwaS1sYWJlbCB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgbGV0dGVyLXNwYWNpbmc6IDEuNXB4OwogICAgY29sb3I6IHZhcigtLW11dGVkKTsKICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgfQoKICAua3BpLXZhbHVlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3luZScsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDI2cHg7CiAgICBmb250LXdlaWdodDogODAwOwogICAgbGluZS1oZWlnaHQ6IDE7CiAgICBtYXJnaW4tYm90dG9tOiA2cHg7CiAgfQoKICAua3BpLXN1YiB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tbXV0ZWQpOwogIH0KCiAgLmtwaS1pY29uIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHJpZ2h0OiAxNnB4OyB0b3A6IDE2cHg7CiAgICBmb250LXNpemU6IDIycHg7CiAgICBvcGFjaXR5OiAwLjE1OwogIH0KCiAgLnVwICAgeyBjb2xvcjogdmFyKC0tZ3JlZW4pOyB9CiAgLmRvd24geyBjb2xvcjogdmFyKC0tcmVkKTsgfQogIC5uZXUgIHsgY29sb3I6IHZhcigtLWFjY2VudCk7IH0KICAuZ29sZCB7IGNvbG9yOiB2YXIoLS1nb2xkKTsgfQoKICAvKiDilIDilIAgU2VjdGlvbiBsYWJlbHMg4pSA4pSAICovCiAgLnNlY3Rpb24tbGFiZWwgewogICAgZm9udC1mYW1pbHk6ICdTeW5lJywgc2Fucy1zZXJpZjsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICBsZXR0ZXItc3BhY2luZzogMnB4OwogICAgY29sb3I6IHZhcigtLW11dGVkKTsKICAgIG1hcmdpbi1ib3R0b206IDE0cHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGdhcDogMTBweDsKICB9CgogIC5zZWN0aW9uLWxhYmVsOjphZnRlciB7CiAgICBjb250ZW50OiAnJzsKICAgIGZsZXg6IDE7CiAgICBoZWlnaHQ6IDFweDsKICAgIGJhY2tncm91bmQ6IHZhcigtLWJvcmRlcik7CiAgfQoKICAvKiDilIDilIAgQ2hhcnRzIHJvdyDilIDilIAgKi8KICAuY2hhcnRzLXJvdyB7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAyZnIgMWZyOwogICAgZ2FwOiAxNnB4OwogICAgbWFyZ2luLWJvdHRvbTogMjRweDsKICB9CgogIEBtZWRpYSAobWF4LXdpZHRoOiA5MDBweCkgeyAuY2hhcnRzLXJvdyB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOyB9IH0KCiAgLmNhcmQgewogICAgYmFja2dyb3VuZDogdmFyKC0tY2FyZCk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgYm9yZGVyLXJhZGl1czogMTZweDsKICAgIHBhZGRpbmc6IDIycHg7CiAgICBhbmltYXRpb246IGZhZGVVcCAwLjZzIGVhc2UgYm90aDsKICB9CgogIC5jYXJkLXRpdGxlIHsKICAgIGZvbnQtZmFtaWx5OiAnU3luZScsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDEzcHg7CiAgICBmb250LXdlaWdodDogNzAwOwogICAgbWFyZ2luLWJvdHRvbTogMThweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogIH0KCiAgLmNhcmQtYmFkZ2UgewogICAgZm9udC1mYW1pbHk6ICdKZXRCcmFpbnMgTW9ubycsIG1vbm9zcGFjZTsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIHBhZGRpbmc6IDNweCAxMHB4OwogICAgYm9yZGVyLXJhZGl1czogMjBweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMCwyMTIsMjU1LDAuMDgpOwogICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLDIxMiwyNTUsMC4yKTsKICAgIGNvbG9yOiB2YXIoLS1hY2NlbnQpOwogIH0KCiAgLyog4pSA4pSAIEJvdHRvbSBncmlkIOKUgOKUgCAqLwogIC5ib3R0b20tZ3JpZCB7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMWZyIDFmcjsKICAgIGdhcDogMTZweDsKICAgIG1hcmdpbi1ib3R0b206IDI0cHg7CiAgfQoKICBAbWVkaWEgKG1heC13aWR0aDogMTEwMHB4KSB7IC5ib3R0b20tZ3JpZCB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsgfSB9CiAgQG1lZGlhIChtYXgtd2lkdGg6IDcwMHB4KSAgeyAuYm90dG9tLWdyaWQgeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsgfSB9CgogIC8qIOKUgOKUgCBUcmFkZSB0YWJsZSDilIDilIAgKi8KICAudHJhZGUtdGFibGUtd3JhcCB7CiAgICBvdmVyZmxvdy14OiBhdXRvOwogIH0KCiAgdGFibGUgewogICAgd2lkdGg6IDEwMCU7CiAgICBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOwogICAgZm9udC1zaXplOiAxMnB4OwogIH0KCiAgdGhlYWQgdGggewogICAgZm9udC1zaXplOiAxMHB4OwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBjb2xvcjogdmFyKC0tbXV0ZWQpOwogICAgcGFkZGluZzogOHB4IDEycHg7CiAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogIH0KCiAgdGJvZHkgdHIgewogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMzAsNDUsNjksMC41KTsKICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQgMC4xNXM7CiAgfQoKICB0Ym9keSB0cjpob3ZlciB7IGJhY2tncm91bmQ6IHJnYmEoMCwyMTIsMjU1LDAuMDMpOyB9CgogIHRib2R5IHRkIHsKICAgIHBhZGRpbmc6IDEwcHggMTJweDsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgfQoKICAuYmFkZ2UgewogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgcGFkZGluZzogMnB4IDhweDsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgIGZvbnQtc2l6ZTogMTBweDsKICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICBsZXR0ZXItc3BhY2luZzogMC41cHg7CiAgfQoKICAuYmFkZ2UtY2UgeyBiYWNrZ3JvdW5kOiByZ2JhKDAsMjMwLDExOCwwLjEyKTsgY29sb3I6IHZhcigtLWdyZWVuKTsgYm9yZGVyOiAxcHggc29saWQgcmdiYSgwLDIzMCwxMTgsMC4yNSk7IH0KICAuYmFkZ2UtcGUgeyBiYWNrZ3JvdW5kOiByZ2JhKDI1NSw2MSwxMDcsMC4xMik7IGNvbG9yOiB2YXIoLS1yZWQpOyAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LDYxLDEwNywwLjI1KTsgfQogIC5iYWRnZS1zbCB7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDYxLDEwNywwLjEyKTsgY29sb3I6IHZhcigtLXJlZCk7ICAgfQogIC5iYWRnZS10cCB7IGJhY2tncm91bmQ6IHJnYmEoMCwyMzAsMTE4LDAuMTIpOyAgY29sb3I6IHZhcigtLWdyZWVuKTsgfQogIC5iYWRnZS10ciB7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDIxNSw5NiwwLjEyKTsgY29sb3I6IHZhcigtLWdvbGQpOyAgfQogIC5iYWRnZS1lb2R7IGJhY2tncm91bmQ6IHJnYmEoMTAwLDExNiwxMzksMC4yKTsgY29sb3I6IHZhcigtLW11dGVkKTsgfQoKICAvKiDilIDilIAgVW5pdCBjYXJkcyDilIDilIAgKi8KICAudW5pdHMtZ3JpZCB7CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoNSwxZnIpOwogICAgZ2FwOiAxMHB4OwogICAgbWFyZ2luLWJvdHRvbTogMjRweDsKICB9CgogIEBtZWRpYSAobWF4LXdpZHRoOiA5MDBweCkgeyAudW5pdHMtZ3JpZCB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDMsMWZyKTsgfSB9CgogIC51bml0LWNhcmQgewogICAgYmFja2dyb3VuZDogdmFyKC0tY2FyZCk7CiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgIHBhZGRpbmc6IDE2cHggMTRweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4yczsKICAgIGFuaW1hdGlvbjogZmFkZVVwIDAuNXMgZWFzZSBib3RoOwogIH0KCiAgLnVuaXQtY2FyZDpob3ZlciB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsgfQoKICAudW5pdC1jYXJkOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBib3R0b206IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOwogICAgaGVpZ2h0OiAzcHg7CiAgfQoKICAudW5pdC1wb3NpdGl2ZTo6YmVmb3JlIHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB2YXIoLS1ncmVlbiksIHRyYW5zcGFyZW50KTsgfQogIC51bml0LW5lZ2F0aXZlOjpiZWZvcmUgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHZhcigtLXJlZCksIHRyYW5zcGFyZW50KTsgfQoKICAudW5pdC1pZCB7CiAgICBmb250LXNpemU6IDEwcHg7CiAgICBjb2xvcjogdmFyKC0tbXV0ZWQpOwogICAgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICAgIGxldHRlci1zcGFjaW5nOiAxcHg7CiAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgfQoKICAudW5pdC1jYXBpdGFsIHsKICAgIGZvbnQtZmFtaWx5OiAnU3luZScsIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDE4cHg7CiAgICBmb250LXdlaWdodDogODAwOwogICAgbWFyZ2luLWJvdHRvbTogNHB4OwogIH0KCiAgLnVuaXQtcG5sIHsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgfQoKICAudW5pdC10cmFkZXMgewogICAgZm9udC1zaXplOiAxMHB4OwogICAgY29sb3I6IHZhcigtLW11dGVkKTsKICAgIG1hcmdpbi10b3A6IDZweDsKICB9CgogIC8qIOKUgOKUgCBQcm9ncmVzcyBiYXIg4pSA4pSAICovCiAgLnByb2dyZXNzLXdyYXAgeyBtYXJnaW4tdG9wOiAxMHB4OyB9CgogIC5wcm9ncmVzcy1iYXIgewogICAgaGVpZ2h0OiA0cHg7CiAgICBiYWNrZ3JvdW5kOiB2YXIoLS1ib3JkZXIpOwogICAgYm9yZGVyLXJhZGl1czogMnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICB9CgogIC5wcm9ncmVzcy1maWxsIHsKICAgIGhlaWdodDogMTAwJTsKICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgIHRyYW5zaXRpb246IHdpZHRoIDFzIGVhc2U7CiAgfQoKICAvKiDilIDilIAgU2lnbmFsIGxvZyDilIDilIAgKi8KICAuc2lnbmFsLWxvZyB7CiAgICBtYXgtaGVpZ2h0OiAyODBweDsKICAgIG92ZXJmbG93LXk6IGF1dG87CiAgfQoKICAuc2lnbmFsLWxvZzo6LXdlYmtpdC1zY3JvbGxiYXIgeyB3aWR0aDogNHB4OyB9CiAgLnNpZ25hbC1sb2c6Oi13ZWJraXQtc2Nyb2xsYmFyLXRyYWNrIHsgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7IH0KICAuc2lnbmFsLWxvZzo6LXdlYmtpdC1zY3JvbGxiYXItdGh1bWIgeyBiYWNrZ3JvdW5kOiB2YXIoLS1ib3JkZXIpOyBib3JkZXItcmFkaXVzOiAycHg7IH0KCiAgLnNpZ25hbC1yb3cgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDEwcHg7CiAgICBwYWRkaW5nOiA4cHggMDsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCByZ2JhKDMwLDQ1LDY5LDAuNCk7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBhbmltYXRpb246IGZhZGVJbiAwLjNzIGVhc2U7CiAgfQoKICAuc2lnbmFsLXRpbWUgeyBjb2xvcjogdmFyKC0tbXV0ZWQpOyB3aWR0aDogMTIwcHg7IGZsZXgtc2hyaW5rOiAwOyB9CiAgLnNpZ25hbC1zcG90IHsgY29sb3I6IHZhcigtLXRleHQpOyB3aWR0aDogNzBweDsgfQoKICAvKiDilIDilIAgRXhpdCBicmVha2Rvd24g4pSA4pSAICovCiAgLmV4aXQtcm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgcGFkZGluZzogMTBweCAwOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYmEoMzAsNDUsNjksMC40KTsKICB9CgogIC5leGl0LWxhYmVsIHsgZm9udC1zaXplOiAxMnB4OyBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDhweDsgfQogIC5leGl0LWRvdCAgIHsgd2lkdGg6IDhweDsgaGVpZ2h0OiA4cHg7IGJvcmRlci1yYWRpdXM6IDUwJTsgfQogIC5leGl0LXN0YXRzIHsgdGV4dC1hbGlnbjogcmlnaHQ7IGZvbnQtc2l6ZTogMTFweDsgfQogIC5leGl0LXBubCAgIHsgZm9udC13ZWlnaHQ6IDYwMDsgfQoKICAvKiDilIDilIAgQW5pbWF0aW9ucyDilIDilIAgKi8KICBAa2V5ZnJhbWVzIGZhZGVVcCB7CiAgICBmcm9tIHsgb3BhY2l0eTogMDsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDE2cHgpOyB9CiAgICB0byAgIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyB9CiAgfQoKICBAa2V5ZnJhbWVzIGZhZGVJbiB7CiAgICBmcm9tIHsgb3BhY2l0eTogMDsgfQogICAgdG8gICB7IG9wYWNpdHk6IDE7IH0KICB9CgogIC8qIHN0YWdnZXIgY2FyZHMgKi8KICAua3BpOm50aC1jaGlsZCgxKSB7IGFuaW1hdGlvbi1kZWxheTogMC4wNXM7IH0KICAua3BpOm50aC1jaGlsZCgyKSB7IGFuaW1hdGlvbi1kZWxheTogMC4xMHM7IH0KICAua3BpOm50aC1jaGlsZCgzKSB7IGFuaW1hdGlvbi1kZWxheTogMC4xNXM7IH0KICAua3BpOm50aC1jaGlsZCg0KSB7IGFuaW1hdGlvbi1kZWxheTogMC4yMHM7IH0KICAua3BpOm50aC1jaGlsZCg1KSB7IGFuaW1hdGlvbi1kZWxheTogMC4yNXM7IH0KICAua3BpOm50aC1jaGlsZCg2KSB7IGFuaW1hdGlvbi1kZWxheTogMC4zMHM7IH0KCiAgLyog4pSA4pSAIEVtcHR5IHN0YXRlIOKUgOKUgCAqLwogIC5lbXB0eSB7CiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICBwYWRkaW5nOiA0MHB4IDIwcHg7CiAgICBjb2xvcjogdmFyKC0tbXV0ZWQpOwogICAgZm9udC1zaXplOiAxMnB4OwogIH0KCiAgLmVtcHR5LWljb24geyBmb250LXNpemU6IDMycHg7IG1hcmdpbi1ib3R0b206IDEwcHg7IH0KCiAgLyog4pSA4pSAIFRpY2tlciB0YXBlIOKUgOKUgCAqLwogIC50aWNrZXItd3JhcCB7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgIHBhZGRpbmc6IDhweCAwOwogICAgbWFyZ2luLWJvdHRvbTogMjRweDsKICAgIGJhY2tncm91bmQ6IHJnYmEoMTMsMjAsMzIsMC42KTsKICB9CgogIC50aWNrZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogNjBweDsKICAgIGFuaW1hdGlvbjogc2Nyb2xsIDMwcyBsaW5lYXIgaW5maW5pdGU7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogIH0KCiAgLnRpY2tlci1pdGVtIHsKICAgIGZvbnQtc2l6ZTogMTFweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDhweDsKICAgIGNvbG9yOiB2YXIoLS1tdXRlZCk7CiAgfQoKICAudGlja2VyLWl0ZW0gc3Ryb25nIHsgY29sb3I6IHZhcigtLXRleHQpOyB9CgogIEBrZXlmcmFtZXMgc2Nyb2xsIHsKICAgIGZyb20geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCk7IH0KICAgIHRvICAgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7IH0KICB9CgogIC8qIOKUgOKUgCBUb29sdGlwIOKUgOKUgCAqLwogIC50b29sdGlwLXRyaWdnZXIgeyBjdXJzb3I6IGhlbHA7IGJvcmRlci1ib3R0b206IDFweCBkYXNoZWQgdmFyKC0tbXV0ZWQpOyB9CgogIC8qIOKUgOKUgCBSZWZyZXNoIGJ0biDilIDilIAgKi8KICAucmVmcmVzaC1idG4gewogICAgYmFja2dyb3VuZDogcmdiYSgwLDIxMiwyNTUsMC4wOCk7CiAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDAsMjEyLDI1NSwwLjIpOwogICAgY29sb3I6IHZhcigtLWFjY2VudCk7CiAgICBwYWRkaW5nOiA3cHggMTZweDsKICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgIGZvbnQtZmFtaWx5OiAnSmV0QnJhaW5zIE1vbm8nLCBtb25vc3BhY2U7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICB9CgogIC5yZWZyZXNoLWJ0bjpob3ZlciB7CiAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMjEyLDI1NSwwLjE1KTsKICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwyMTIsMjU1LDAuMik7CiAgfQoKICAvKiDilIDilIAgRG9udXQgbGFiZWxzIOKUgOKUgCAqLwogIC5kb251dC13cmFwIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIHdpZHRoOiAxNjBweDsKICAgIGhlaWdodDogMTYwcHg7CiAgICBtYXJnaW46IDAgYXV0bzsKICB9CgogIC5kb251dC1jZW50ZXIgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgaW5zZXQ6IDA7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogIH0KCiAgLmRvbnV0LXBjdCB7CiAgICBmb250LWZhbWlseTogJ1N5bmUnLCBzYW5zLXNlcmlmOwogICAgZm9udC1zaXplOiAyOHB4OwogICAgZm9udC13ZWlnaHQ6IDgwMDsKICB9CgogIC5kb251dC1zdWIgeyBmb250LXNpemU6IDEwcHg7IGNvbG9yOiB2YXIoLS1tdXRlZCk7IH0KPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KCjwhLS0gSEVBREVSIC0tPgo8aGVhZGVyPgogIDxkaXYgY2xhc3M9ImxvZ28iPgogICAgPGRpdiBjbGFzcz0ibG9nby1pY29uIj7wn5OIPC9kaXY+CiAgICA8ZGl2PgogICAgICA8ZGl2IGNsYXNzPSJsb2dvLXRleHQiPk5JRlRZIDxzcGFuPkJPVDwvc3Bhbj48L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEwcHg7Y29sb3I6dmFyKC0tbXV0ZWQpO2xldHRlci1zcGFjaW5nOjFweDsiPlBBUEVSIFRSQURJTkcgREFTSEJPQVJEPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJoZWFkZXItcmlnaHQiPgogICAgPGRpdiBjbGFzcz0ibGFzdC11cGRhdGUiIGlkPSJsYXN0VXBkYXRlIj5Mb2FkaW5nLi4uPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJsaXZlLWJhZGdlIj48ZGl2IGNsYXNzPSJsaXZlLWRvdCI+PC9kaXY+UEFQRVIgTElWRTwvZGl2PgogICAgPGJ1dHRvbiBjbGFzcz0icmVmcmVzaC1idG4iIG9uY2xpY2s9ImxvYWREYXRhKCkiPuKfsyBSZWZyZXNoPC9idXR0b24+CiAgPC9kaXY+CjwvaGVhZGVyPgoKPCEtLSBUSUNLRVIgLS0+CjxkaXYgY2xhc3M9InRpY2tlci13cmFwIj4KICA8ZGl2IGNsYXNzPSJ0aWNrZXIiIGlkPSJ0aWNrZXIiPgogICAgPGRpdiBjbGFzcz0idGlja2VyLWl0ZW0iPjxzdHJvbmc+TklGVFkgQk9UPC9zdHJvbmc+IFBhcGVyIFRyYWRpbmcgQWN0aXZlPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0aWNrZXItaXRlbSI+PHN0cm9uZz5TVFJBVEVHWTwvc3Ryb25nPiBFTUEgOS8yMS81MCArIEJCICsgUlNJICsgQURYICsgVldBUDwvZGl2PgogICAgPGRpdiBjbGFzcz0idGlja2VyLWl0ZW0iPjxzdHJvbmc+Q0FQSVRBTDwvc3Ryb25nPiDigrkxLDAwLDAwMCB8IDUgVW5pdHMgw5cg4oK5MjAsMDAwPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0aWNrZXItaXRlbSI+PHN0cm9uZz5TTDwvc3Ryb25nPiAtNDAlIFByZW1pdW0gfCA8c3Ryb25nPlRQPC9zdHJvbmc+ICsxMDAlIFByZW1pdW08L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRpY2tlci1pdGVtIj48c3Ryb25nPlRJTUVGUkFNRTwvc3Ryb25nPiAxNS1NaW4gQ2FuZGxlczwvZGl2PgogICAgPGRpdiBjbGFzcz0idGlja2VyLWl0ZW0iPjxzdHJvbmc+TklGVFkgQk9UPC9zdHJvbmc+IFBhcGVyIFRyYWRpbmcgQWN0aXZlPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0aWNrZXItaXRlbSI+PHN0cm9uZz5TVFJBVEVHWTwvc3Ryb25nPiBFTUEgOS8yMS81MCArIEJCICsgUlNJICsgQURYICsgVldBUDwvZGl2PgogICAgPGRpdiBjbGFzcz0idGlja2VyLWl0ZW0iPjxzdHJvbmc+Q0FQSVRBTDwvc3Ryb25nPiDigrkxLDAwLDAwMCB8IDUgVW5pdHMgw5cg4oK5MjAsMDAwPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0aWNrZXItaXRlbSI+PHN0cm9uZz5TTDwvc3Ryb25nPiAtNDAlIFByZW1pdW0gfCA8c3Ryb25nPlRQPC9zdHJvbmc+ICsxMDAlIFByZW1pdW08L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRpY2tlci1pdGVtIj48c3Ryb25nPlRJTUVGUkFNRTwvc3Ryb25nPiAxNS1NaW4gQ2FuZGxlczwvZGl2PgogIDwvZGl2Pgo8L2Rpdj4KCjxtYWluPgoKICA8IS0tIEtQSSBDQVJEUyAtLT4KICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWxhYmVsIj5QZXJmb3JtYW5jZSBPdmVydmlldzwvZGl2PgogIDxkaXYgY2xhc3M9ImtwaS1ncmlkIiBpZD0ia3BpR3JpZCI+CiAgICA8IS0tIGZpbGxlZCBieSBKUyAtLT4KICA8L2Rpdj4KCiAgPCEtLSBVTklUIFNUQVRVUyAtLT4KICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWxhYmVsIj5Vbml0IFN0YXR1czwvZGl2PgogIDxkaXYgY2xhc3M9InVuaXRzLWdyaWQiIGlkPSJ1bml0c0dyaWQiPjwvZGl2PgoKICA8IS0tIEVRVUlUWSArIFdJTiBSQVRFIC0tPgogIDxkaXYgY2xhc3M9InNlY3Rpb24tbGFiZWwiPkNoYXJ0czwvZGl2PgogIDxkaXYgY2xhc3M9ImNoYXJ0cy1yb3ciPgogICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgIDxkaXYgY2xhc3M9ImNhcmQtdGl0bGUiPgogICAgICAgIEVxdWl0eSBDdXJ2ZQogICAgICAgIDxzcGFuIGNsYXNzPSJjYXJkLWJhZGdlIiBpZD0iZXF1aXR5QmFkZ2UiPuKAlDwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICAgIDxjYW52YXMgaWQ9ImVxdWl0eUNoYXJ0IiBoZWlnaHQ9IjIwMCI+PC9jYW52YXM+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgICA8ZGl2IGNsYXNzPSJjYXJkLXRpdGxlIj5XaW4gUmF0ZTwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJkb251dC13cmFwIj4KICAgICAgICA8Y2FudmFzIGlkPSJ3aW5DaGFydCI+PC9jYW52YXM+CiAgICAgICAgPGRpdiBjbGFzcz0iZG9udXQtY2VudGVyIj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImRvbnV0LXBjdCIgaWQ9IndpblBjdCIgc3R5bGU9ImNvbG9yOnZhcigtLWdyZWVuKSI+4oCUPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJkb251dC1zdWIiPldJTiBSQVRFPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjIwcHg7Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJleGl0LXJvdyI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJleGl0LWxhYmVsIj48ZGl2IGNsYXNzPSJleGl0LWRvdCIgc3R5bGU9ImJhY2tncm91bmQ6dmFyKC0tZ3JlZW4pIj48L2Rpdj5XaW5uaW5nIFRyYWRlczwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0iZXhpdC1zdGF0cyI+PGRpdiBjbGFzcz0iZXhpdC1wbmwgdXAiIGlkPSJ3aW5Db3VudCI+4oCUPC9kaXY+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZXhpdC1yb3ciPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXhpdC1sYWJlbCI+PGRpdiBjbGFzcz0iZXhpdC1kb3QiIHN0eWxlPSJiYWNrZ3JvdW5kOnZhcigtLXJlZCkiPjwvZGl2Pkxvc2luZyBUcmFkZXM8L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImV4aXQtc3RhdHMiPjxkaXYgY2xhc3M9ImV4aXQtcG5sIGRvd24iIGlkPSJsb3NzQ291bnQiPuKAlDwvZGl2PjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImV4aXQtcm93IiBzdHlsZT0iYm9yZGVyOm5vbmUiPgogICAgICAgICAgPGRpdiBjbGFzcz0iZXhpdC1sYWJlbCI+PGRpdiBjbGFzcz0iZXhpdC1kb3QiIHN0eWxlPSJiYWNrZ3JvdW5kOnZhcigtLWdvbGQpIj48L2Rpdj5Qcm9maXQgRmFjdG9yPC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJleGl0LXN0YXRzIj48ZGl2IGNsYXNzPSJleGl0LXBubCBnb2xkIiBpZD0icGZEaXNwbGF5Ij7igJQ8L2Rpdj48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KCiAgPCEtLSBCT1RUT00gR1JJRDogZGFpbHkgcG5sLCBleGl0IGJyZWFrZG93biwgc2lnbmFsIGxvZyAtLT4KICA8ZGl2IGNsYXNzPSJib3R0b20tZ3JpZCI+CiAgICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgICAgPGRpdiBjbGFzcz0iY2FyZC10aXRsZSI+RGFpbHkgUCZhbXA7TCA8c3BhbiBjbGFzcz0iY2FyZC1iYWRnZSIgaWQ9ImRheXNCYWRnZSI+MCBkYXlzPC9zcGFuPjwvZGl2PgogICAgICA8Y2FudmFzIGlkPSJkYWlseUNoYXJ0IiBoZWlnaHQ9IjIyMCI+PC9jYW52YXM+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImNhcmQiPgogICAgICA8ZGl2IGNsYXNzPSJjYXJkLXRpdGxlIj5FeGl0IEJyZWFrZG93bjwvZGl2PgogICAgICA8ZGl2IGlkPSJleGl0QnJlYWtkb3duIj48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0iY2FyZCI+CiAgICAgIDxkaXYgY2xhc3M9ImNhcmQtdGl0bGUiPlNpZ25hbCBMb2cgPHNwYW4gY2xhc3M9ImNhcmQtYmFkZ2UiIGlkPSJzaWdCYWRnZSI+MCBzaWduYWxzPC9zcGFuPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJzaWduYWwtbG9nIiBpZD0ic2lnbmFsTG9nIj48L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8IS0tIFRSQURFIFRBQkxFIC0tPgogIDxkaXYgY2xhc3M9InNlY3Rpb24tbGFiZWwiPlRyYWRlIEhpc3Rvcnk8L2Rpdj4KICA8ZGl2IGNsYXNzPSJjYXJkIj4KICAgIDxkaXYgY2xhc3M9ImNhcmQtdGl0bGUiPgogICAgICBBbGwgVHJhZGVzCiAgICAgIDxzcGFuIGNsYXNzPSJjYXJkLWJhZGdlIiBpZD0idHJhZGVCYWRnZSI+MCB0cmFkZXM8L3NwYW4+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRyYWRlLXRhYmxlLXdyYXAiPgogICAgICA8dGFibGU+CiAgICAgICAgPHRoZWFkPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+IzwvdGg+CiAgICAgICAgICAgIDx0aD5Vbml0PC90aD4KICAgICAgICAgICAgPHRoPlR5cGU8L3RoPgogICAgICAgICAgICA8dGg+U3ltYm9sPC90aD4KICAgICAgICAgICAgPHRoPlN0cmlrZTwvdGg+CiAgICAgICAgICAgIDx0aD5FbnRyeSBUaW1lPC90aD4KICAgICAgICAgICAgPHRoPkV4aXQgVGltZTwvdGg+CiAgICAgICAgICAgIDx0aD5FbnRyeSBQcmVtPC90aD4KICAgICAgICAgICAgPHRoPkV4aXQgUHJlbTwvdGg+CiAgICAgICAgICAgIDx0aD5RdHk8L3RoPgogICAgICAgICAgICA8dGg+UCZMPC90aD4KICAgICAgICAgICAgPHRoPkJhcnM8L3RoPgogICAgICAgICAgICA8dGg+RXhpdCBSZWFzb248L3RoPgogICAgICAgICAgPC90cj4KICAgICAgICA8L3RoZWFkPgogICAgICAgIDx0Ym9keSBpZD0idHJhZGVUYWJsZUJvZHkiPjwvdGJvZHk+CiAgICAgIDwvdGFibGU+CiAgICAgIDxkaXYgY2xhc3M9ImVtcHR5IiBpZD0idHJhZGVFbXB0eSIgc3R5bGU9ImRpc3BsYXk6bm9uZSI+CiAgICAgICAgPGRpdiBjbGFzcz0iZW1wdHktaWNvbiI+8J+TrTwvZGl2PgogICAgICAgIE5vIHRyYWRlcyB5ZXQuIEJvdCB3aWxsIHN0YXJ0IHRyYWRpbmcgb24gdGhlIG5leHQgbWFya2V0IG9wZW4uCiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9kaXY+Cgo8L21haW4+Cgo8c2NyaXB0PgovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKLy8gREVNTyBEQVRBIOKAlCBSZXBsYWNlIGZldGNoKCkgY2FsbHMgd2l0aCB5b3VyIEFQSQovLyB3aGVuIHlvdSBhZGQgdGhlIEZsYXNrIGJhY2tlbmQgKHNlZSBkYXNoYm9hcmRfYXBpLnB5KQovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKCmZ1bmN0aW9uIGdlbmVyYXRlRGVtb0RhdGEoKSB7CiAgY29uc3QgdHJhZGVzID0gW107CiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsKICBsZXQgY2FwaXRhbCA9IFsyMDAwMCwyMDAwMCwyMDAwMCwyMDAwMCwyMDAwMF07CiAgY29uc3Qgc3ltYm9scyA9IFsiTklGVFkyMjE1MENFMjdGRUIiLCJOSUZUWTIyMTAwUEUyN0ZFQiIsIk5JRlRZMjIyMDBDRTA2TUFSIiwiTklGVFkyMjA1MFBFMDZNQVIiXTsKICBjb25zdCByZWFzb25zID0gWyJUUF9QUkVNIiwiU0xfUFJFTSIsIlRQX1BSRU0iLCJUUkFJTCIsIkVPRCIsIlNMX1BSRU0iLCJUUF9QUkVNIiwiVFJBSUwiLCJTTF9QUkVNIiwiVFBfUFJFTSJdOwogIGNvbnN0IHR5cGVzICAgPSBbIkNFIiwiUEUiLCJDRSIsIlBFIiwiQ0UiLCJQRSIsIkNFIiwiUEUiLCJDRSIsIkNFIl07CgogIGZvciAobGV0IGkgPSAwOyBpIDwgMjg7IGkrKykgewogICAgY29uc3QgZGF5c0FnbyA9IE1hdGguZmxvb3IoaSAvIDMpOwogICAgY29uc3QgZXQgPSBuZXcgRGF0ZShub3cpOyBldC5zZXREYXRlKGV0LmdldERhdGUoKSAtIGRheXNBZ28pOyBldC5zZXRIb3Vycyg5K01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSo0KSwgWzMwLDQ1LDAsMTVdW2klNF0pOwogICAgY29uc3QgeHQgPSBuZXcgRGF0ZShldCk7IHh0LnNldE1pbnV0ZXMoeHQuZ2V0TWludXRlcygpICsgKDIrTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKjgpKSoxNSk7CiAgICBjb25zdCB1aWQgPSBpICUgNTsKICAgIGNvbnN0IG90eXBlID0gdHlwZXNbaSUxMF07CiAgICBjb25zdCBlcCA9IDgwICsgTWF0aC5yYW5kb20oKSoxMjA7CiAgICBjb25zdCByZWFzb24gPSByZWFzb25zW2klMTBdOwogICAgbGV0IHhwOwogICAgaWYocmVhc29uPT09IlRQX1BSRU0iKSB4cCA9IGVwICogKDEuNyArIE1hdGgucmFuZG9tKCkqMC41KTsKICAgIGVsc2UgaWYocmVhc29uPT09IlNMX1BSRU0iKSB4cCA9IGVwICogKDAuNSArIE1hdGgucmFuZG9tKCkqMC4yKTsKICAgIGVsc2UgaWYocmVhc29uPT09IlRSQUlMIikgeHAgPSBlcCAqICgxLjIgKyBNYXRoLnJhbmRvbSgpKjAuMyk7CiAgICBlbHNlIHhwID0gZXAgKiAoMC43ICsgTWF0aC5yYW5kb20oKSowLjYpOwogICAgY29uc3QgbHMgPSA2NSwgcXR5ID0gMSArIChNYXRoLnJhbmRvbSgpPjAuNj8xOjApOwogICAgY29uc3QgcG5sID0gTWF0aC5yb3VuZCgoeHAtZXApKmxzKnF0eSAtIChlcCt4cCkqMC4wMDMqbHMqcXR5KTsKICAgIGNhcGl0YWxbdWlkXSArPSBwbmw7CiAgICB0cmFkZXMucHVzaCh7CiAgICAgIGlkOiBpKzEsIHVuaXQ6IHVpZCwgb3B0X3R5cGU6IG90eXBlLAogICAgICBzeW1ib2w6IHN5bWJvbHNbaSVzeW1ib2xzLmxlbmd0aF0sIHN0cmlrZTogMjIxMDArKChpJTUpKjUwKSwKICAgICAgZW50cnlfdGltZTogZXQudG9JU09TdHJpbmcoKSwgZXhpdF90aW1lOiB4dC50b0lTT1N0cmluZygpLAogICAgICBlbnRyeV9wcmVtOiBNYXRoLnJvdW5kKGVwKjEwKS8xMCwgZXhpdF9wcmVtOiBNYXRoLnJvdW5kKHhwKjEwKS8xMCwKICAgICAgcXR5LCBsb3Rfc2l6ZTogbHMsIGJhcnNfaGVsZDogMitNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqNiksCiAgICAgIHBubCwgcmVhc29uLCBsaXZlX2RhdGE6IE1hdGgucmFuZG9tKCk+MC4zCiAgICB9KTsKICB9CgogIC8vIEJ1aWxkIGVxdWl0eSB0aW1lbGluZQogIGNvbnN0IGVxdWl0eSA9IFtdOwogIGxldCBlcSA9IDEwMDAwMDsKICB0cmFkZXMuc29ydCgoYSxiKT0+bmV3IERhdGUoYS5leGl0X3RpbWUpLW5ldyBEYXRlKGIuZXhpdF90aW1lKSk7CiAgdHJhZGVzLmZvckVhY2godCA9PiB7IGVxICs9IHQucG5sOyBlcXVpdHkucHVzaCh7IHRzOiB0LmV4aXRfdGltZSwgZXEgfSk7IH0pOwoKICAvLyBEYWlseSBzdW1tYXJ5CiAgY29uc3QgZGFpbHlNYXAgPSB7fTsKICB0cmFkZXMuZm9yRWFjaCh0ID0+IHsKICAgIGNvbnN0IGQgPSB0LmVudHJ5X3RpbWUuc3BsaXQoIlQiKVswXTsKICAgIGlmICghZGFpbHlNYXBbZF0pIGRhaWx5TWFwW2RdID0geyBkYXRlOiBkLCBkYWlseV9wbmw6IDAsIHRvdGFsX3RyYWRlczogMCwgd2lubmluZ190cmFkZXM6IDAgfTsKICAgIGRhaWx5TWFwW2RdLmRhaWx5X3BubCArPSB0LnBubDsKICAgIGRhaWx5TWFwW2RdLnRvdGFsX3RyYWRlcysrOwogICAgaWYgKHQucG5sID4gMCkgZGFpbHlNYXBbZF0ud2lubmluZ190cmFkZXMrKzsKICB9KTsKICBjb25zdCBkYWlseSA9IE9iamVjdC52YWx1ZXMoZGFpbHlNYXApLnNvcnQoKGEsYik9PmEuZGF0ZS5sb2NhbGVDb21wYXJlKGIuZGF0ZSkpOwoKICAvLyBTaWduYWxzCiAgY29uc3Qgc2lnbmFscyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgNDI7IGkrKykgewogICAgY29uc3QgZCA9IG5ldyBEYXRlKG5vdyk7IGQuc2V0RGF0ZShkLmdldERhdGUoKS1NYXRoLmZsb29yKGkvNCkpOwogICAgZC5zZXRIb3Vycyg5K01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSo1KSwgWzMwLDQ1LDAsMTVdW2klNF0pOwogICAgc2lnbmFscy5wdXNoKHsKICAgICAgZGF0ZXRpbWU6IGQudG9JU09TdHJpbmcoKSwKICAgICAgZGlyZWN0aW9uOiBNYXRoLnJhbmRvbSgpPjAuNT8iQ0UiOiJQRSIsCiAgICAgIHNwb3Q6IDIyMTAwK01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSozMDApLAogICAgICBhZHg6IDIwK01hdGgucmFuZG9tKCkqMjAsCiAgICAgIHJzaTogNDArTWF0aC5yYW5kb20oKSoyNSwKICAgICAgYWN0ZWRfb246IE1hdGgucmFuZG9tKCk+MC4zNT8xOjAKICAgIH0pOwogIH0KCiAgLy8gVW5pdCBzdGF0cwogIGNvbnN0IHVuaXRTdGF0cyA9IGNhcGl0YWwubWFwKChjYXAsaSk9Pih7CiAgICB1aWQ6IGksIGNhcGl0YWw6IE1hdGgucm91bmQoY2FwKjEwMCkvMTAwLAogICAgcG5sOiBNYXRoLnJvdW5kKChjYXAtMjAwMDApKjEwMCkvMTAwLAogICAgdHJhZGVzOiB0cmFkZXMuZmlsdGVyKHQ9PnQudW5pdD09PWkpLmxlbmd0aAogIH0pKTsKCiAgcmV0dXJuIHsgdHJhZGVzLCBlcXVpdHksIGRhaWx5LCBzaWduYWxzLCB1bml0U3RhdHMgfTsKfQoKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCi8vIFJFTkRFUiBGVU5DVElPTlMKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCgpsZXQgZXF1aXR5Q2hhcnRJbnN0ID0gbnVsbDsKbGV0IHdpbkNoYXJ0SW5zdCAgICA9IG51bGw7CmxldCBkYWlseUNoYXJ0SW5zdCAgPSBudWxsOwoKZnVuY3Rpb24gZm10KG4pIHsKICBpZiAobiA9PT0gbnVsbCB8fCBuID09PSB1bmRlZmluZWQpIHJldHVybiAi4oCUIjsKICByZXR1cm4gKG4gPj0gMCA/ICIrIiA6ICIiKSArICLigrkiICsgTWF0aC5hYnMoTWF0aC5yb3VuZChuKSkudG9Mb2NhbGVTdHJpbmcoImVuLUlOIik7Cn0KCmZ1bmN0aW9uIGZtdFJzKG4pIHsKICByZXR1cm4gIuKCuSIgKyBNYXRoLnJvdW5kKG4pLnRvTG9jYWxlU3RyaW5nKCJlbi1JTiIpOwp9CgpmdW5jdGlvbiByZW5kZXJLUElzKGRhdGEpIHsKICBjb25zdCB7IHRyYWRlcywgdW5pdFN0YXRzIH0gPSBkYXRhOwogIGNvbnN0IHRvdGFsQ2FwICA9IHVuaXRTdGF0cy5yZWR1Y2UoKHMsdSk9PnMrdS5jYXBpdGFsLCAwKTsKICBjb25zdCB0b3RhbFBubCAgPSB0b3RhbENhcCAtIDEwMDAwMDsKICBjb25zdCByZXQgICAgICAgPSAodG90YWxDYXAvMTAwMDAwLTEpKjEwMDsKICBjb25zdCB3aW5zICAgICAgPSB0cmFkZXMuZmlsdGVyKHQ9PnQucG5sPjApOwogIGNvbnN0IGxvc3NlcyAgICA9IHRyYWRlcy5maWx0ZXIodD0+dC5wbmw8PTApOwogIGNvbnN0IHdyICAgICAgICA9IHRyYWRlcy5sZW5ndGggPyAod2lucy5sZW5ndGgvdHJhZGVzLmxlbmd0aCoxMDApIDogMDsKICBjb25zdCB3aW5TdW0gICAgPSB3aW5zLnJlZHVjZSgocyx0KT0+cyt0LnBubCwwKTsKICBjb25zdCBsb3NzU3VtICAgPSBsb3NzZXMucmVkdWNlKChzLHQpPT5zK3QucG5sLDApOwogIGNvbnN0IHBmICAgICAgICA9IGxvc3NTdW0gIT09IDAgPyB3aW5TdW0vTWF0aC5hYnMobG9zc1N1bSkgOiAwOwogIGNvbnN0IGF2Z1dpbiAgICA9IHdpbnMubGVuZ3RoID8gd2luU3VtL3dpbnMubGVuZ3RoIDogMDsKICBjb25zdCBhdmdMb3NzICAgPSBsb3NzZXMubGVuZ3RoID8gbG9zc1N1bS9sb3NzZXMubGVuZ3RoIDogMDsKCiAgLy8gTWF4IGRyYXdkb3duIGZyb20gZXF1aXR5CiAgbGV0IHBlYWsgPSAxMDAwMDAsIG1heEREID0gMCwgZXEgPSAxMDAwMDA7CiAgdHJhZGVzLnNvcnQoKGEsYik9Pm5ldyBEYXRlKGEuZXhpdF90aW1lKS1uZXcgRGF0ZShiLmV4aXRfdGltZSkpLmZvckVhY2godD0+ewogICAgZXEgKz0gdC5wbmw7IHBlYWsgPSBNYXRoLm1heChwZWFrLCBlcSk7CiAgICBtYXhERCA9IE1hdGgubWF4KG1heERELCAocGVhay1lcSkvcGVhayoxMDApOwogIH0pOwoKICBjb25zdCBrcGlzID0gWwogICAgeyBsYWJlbDoiVG90YWwgQ2FwaXRhbCIsICB2YWx1ZTogZm10UnModG90YWxDYXApLCAgc3ViOiJTdGFydGVkIOKCuTEsMDAsMDAwIiwgICBjb2xvcjoidmFyKC0tYWNjZW50KSIsIGljb246IvCfkrwiLCBjbHM6IHRvdGFsUG5sPj0wPyJ1cCI6ImRvd24iIH0sCiAgICB7IGxhYmVsOiJUb3RhbCBQJkwiLCAgICAgIHZhbHVlOiBmbXQodG90YWxQbmwpLCAgICAgc3ViOmBSZXR1cm46ICR7cmV0Pj0wPyIrIjoiIn0ke3JldC50b0ZpeGVkKDEpfSVgLCBjb2xvcjogdG90YWxQbmw+PTA/InZhcigtLWdyZWVuKSI6InZhcigtLXJlZCkiLCBpY29uOiLwn5OKIiwgY2xzOiB0b3RhbFBubD49MD8idXAiOiJkb3duIiB9LAogICAgeyBsYWJlbDoiV2luIFJhdGUiLCAgICAgICB2YWx1ZTogd3IudG9GaXhlZCgxKSsiJSIsIHN1YjpgJHt3aW5zLmxlbmd0aH1XIC8gJHtsb3NzZXMubGVuZ3RofUxgLCAgICAgICAgY29sb3I6InZhcigtLWdvbGQpIiwgICBpY29uOiLwn46vIiwgY2xzOiJnb2xkIiB9LAogICAgeyBsYWJlbDoiUHJvZml0IEZhY3RvciIsICB2YWx1ZTogcGYudG9GaXhlZCgyKSwgICAgIHN1YjoiVGFyZ2V0ID4gMS41IiwgICAgICAgIGNvbG9yOiJ2YXIoLS1wdXJwbGUpIiwgaWNvbjoi4pqhIiwgY2xzOiJ1cCIgfSwKICAgIHsgbGFiZWw6IkF2ZyBXaW4iLCAgICAgICAgdmFsdWU6IGZtdChhdmdXaW4pLCAgICAgICAgc3ViOiJQZXIgdHJhZGUiLCAgICAgICAgICAgY29sb3I6InZhcigtLWdyZWVuKSIsICBpY29uOiLinIUiLCBjbHM6InVwIiB9LAogICAgeyBsYWJlbDoiTWF4IERyYXdkb3duIiwgICB2YWx1ZTogIi0iK21heERELnRvRml4ZWQoMSkrIiUiLCBzdWI6IkZyb20gcGVhayIsICAgIGNvbG9yOiJ2YXIoLS1yZWQpIiwgICAgaWNvbjoi8J+TiSIsIGNsczoiZG93biIgfSwKICBdOwoKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgia3BpR3JpZCIpLmlubmVySFRNTCA9IGtwaXMubWFwKGsgPT4gYAogICAgPGRpdiBjbGFzcz0ia3BpIiBzdHlsZT0iLS1hY2NlbnQtY29sb3I6JHtrLmNvbG9yfSI+CiAgICAgIDxkaXYgY2xhc3M9ImtwaS1pY29uIj4ke2suaWNvbn08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ia3BpLWxhYmVsIj4ke2subGFiZWx9PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImtwaS12YWx1ZSAke2suY2xzfSI+JHtrLnZhbHVlfTwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJrcGktc3ViIj4ke2suc3VifTwvZGl2PgogICAgPC9kaXY+CiAgYCkuam9pbigiIik7Cn0KCmZ1bmN0aW9uIHJlbmRlclVuaXRzKGRhdGEpIHsKICBjb25zdCB7IHVuaXRTdGF0cywgdHJhZGVzIH0gPSBkYXRhOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ1bml0c0dyaWQiKS5pbm5lckhUTUwgPSB1bml0U3RhdHMubWFwKHUgPT4gewogICAgY29uc3QgcG9zID0gdS5wbmwgPj0gMDsKICAgIGNvbnN0IHBjdCA9IE1hdGgubWluKDEwMCwgTWF0aC5hYnModS5wbmwpLzIwMDAwKjEwMCk7CiAgICByZXR1cm4gYAogICAgICA8ZGl2IGNsYXNzPSJ1bml0LWNhcmQgJHtwb3M/InVuaXQtcG9zaXRpdmUiOiJ1bml0LW5lZ2F0aXZlIn0iPgogICAgICAgIDxkaXYgY2xhc3M9InVuaXQtaWQiPlVuaXQgJHt1LnVpZH08L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJ1bml0LWNhcGl0YWwgJHtwb3M/InVwIjoiZG93biJ9Ij4ke2ZtdFJzKHUuY2FwaXRhbCl9PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0idW5pdC1wbmwgJHtwb3M/InVwIjoiZG93biJ9Ij4ke2ZtdCh1LnBubCl9PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0idW5pdC10cmFkZXMiPiR7dS50cmFkZXN9IHRyYWRlczwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InByb2dyZXNzLXdyYXAiPgogICAgICAgICAgPGRpdiBjbGFzcz0icHJvZ3Jlc3MtYmFyIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvZ3Jlc3MtZmlsbCIgc3R5bGU9IndpZHRoOiR7cGN0fSU7YmFja2dyb3VuZDoke3Bvcz8idmFyKC0tZ3JlZW4pIjoidmFyKC0tcmVkKSJ9Ij48L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIGA7CiAgfSkuam9pbigiIik7Cn0KCmZ1bmN0aW9uIHJlbmRlckVxdWl0eUNoYXJ0KGRhdGEpIHsKICBjb25zdCB7IGVxdWl0eSwgdHJhZGVzIH0gPSBkYXRhOwogIGlmICghZXF1aXR5Lmxlbmd0aCkgcmV0dXJuOwogIGNvbnN0IGxhYmVscyA9IGVxdWl0eS5tYXAoZSA9PiB7CiAgICBjb25zdCBkID0gbmV3IERhdGUoZS50cyk7CiAgICByZXR1cm4gZC50b0xvY2FsZURhdGVTdHJpbmcoImVuLUlOIix7bW9udGg6InNob3J0IixkYXk6Im51bWVyaWMifSkrIiAiK2QudG9Mb2NhbGVUaW1lU3RyaW5nKCJlbi1JTiIse2hvdXI6IjItZGlnaXQiLG1pbnV0ZToiMi1kaWdpdCJ9KTsKICB9KTsKICBjb25zdCB2YWx1ZXMgPSBlcXVpdHkubWFwKGUgPT4gZS5lcSk7CiAgY29uc3QgZmluYWxFcSA9IHZhbHVlc1t2YWx1ZXMubGVuZ3RoLTFdOwogIGNvbnN0IHJldCA9ICgoZmluYWxFcS8xMDAwMDApLTEpKjEwMDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZXF1aXR5QmFkZ2UiKS50ZXh0Q29udGVudCA9IChyZXQ+PTA/IisiOiIiKStyZXQudG9GaXhlZCgxKSsiJSByZXR1cm4iOwoKICBpZiAoZXF1aXR5Q2hhcnRJbnN0KSBlcXVpdHlDaGFydEluc3QuZGVzdHJveSgpOwogIGNvbnN0IGN0eCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJlcXVpdHlDaGFydCIpLmdldENvbnRleHQoIjJkIik7CiAgY29uc3QgZ3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLDAsMCwzMDApOwogIGdyYWQuYWRkQ29sb3JTdG9wKDAsIGZpbmFsRXE+PTEwMDAwMD8icmdiYSgwLDIzMCwxMTgsMC4zKSI6InJnYmEoMjU1LDYxLDEwNywwLjMpIik7CiAgZ3JhZC5hZGRDb2xvclN0b3AoMSwgInJnYmEoMCwwLDAsMCkiKTsKCiAgZXF1aXR5Q2hhcnRJbnN0ID0gbmV3IENoYXJ0KGN0eCwgewogICAgdHlwZTogImxpbmUiLAogICAgZGF0YTogewogICAgICBsYWJlbHMsCiAgICAgIGRhdGFzZXRzOiBbewogICAgICAgIGRhdGE6IHZhbHVlcywKICAgICAgICBib3JkZXJDb2xvcjogZmluYWxFcT49MTAwMDAwPyIjMDBlNjc2IjoiI2ZmM2Q2YiIsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBncmFkLAogICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgIHBvaW50UmFkaXVzOiAwLAogICAgICAgIHRlbnNpb246IDAuNCwKICAgICAgICBmaWxsOiB0cnVlCiAgICAgIH0sewogICAgICAgIGRhdGE6IEFycmF5KHZhbHVlcy5sZW5ndGgpLmZpbGwoMTAwMDAwKSwKICAgICAgICBib3JkZXJDb2xvcjogInJnYmEoMTAwLDExNiwxMzksMC40KSIsCiAgICAgICAgYm9yZGVyV2lkdGg6IDEsCiAgICAgICAgYm9yZGVyRGFzaDogWzQsNF0sCiAgICAgICAgcG9pbnRSYWRpdXM6IDAsCiAgICAgICAgZmlsbDogZmFsc2UKICAgICAgfV0KICAgIH0sCiAgICBvcHRpb25zOiB7CiAgICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICAgIHBsdWdpbnM6IHsgbGVnZW5kOiB7IGRpc3BsYXk6IGZhbHNlIH0sIHRvb2x0aXA6IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjMTExODI3IiwKICAgICAgICBib3JkZXJDb2xvcjogIiMxZTJkNDUiLAogICAgICAgIGJvcmRlcldpZHRoOiAxLAogICAgICAgIHRpdGxlQ29sb3I6ICIjNjQ3NDhiIiwKICAgICAgICBib2R5Q29sb3I6ICIjZTJlOGYwIiwKICAgICAgICBjYWxsYmFja3M6IHsgbGFiZWw6IGN0eCA9PiAiICDigrkiK01hdGgucm91bmQoY3R4LnJhdykudG9Mb2NhbGVTdHJpbmcoImVuLUlOIikgfQogICAgICB9fSwKICAgICAgc2NhbGVzOiB7CiAgICAgICAgeDogeyBkaXNwbGF5OiBmYWxzZSB9LAogICAgICAgIHk6IHsKICAgICAgICAgIGdyaWQ6IHsgY29sb3I6ICJyZ2JhKDMwLDQ1LDY5LDAuNikiIH0sCiAgICAgICAgICB0aWNrczogeyBjb2xvcjogIiM2NDc0OGIiLCBmb250OntmYW1pbHk6IkpldEJyYWlucyBNb25vIixzaXplOjEwfSwKICAgICAgICAgICAgY2FsbGJhY2s6IHYgPT4gIuKCuSIrTWF0aC5yb3VuZCh2LzEwMDApKyJrIiB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlbmRlcldpbkNoYXJ0KGRhdGEpIHsKICBjb25zdCB7IHRyYWRlcyB9ID0gZGF0YTsKICBjb25zdCB3aW5zICAgPSB0cmFkZXMuZmlsdGVyKHQ9PnQucG5sPjApLmxlbmd0aDsKICBjb25zdCBsb3NzZXMgID0gdHJhZGVzLmZpbHRlcih0PT50LnBubDw9MCkubGVuZ3RoOwogIGNvbnN0IHdyICAgICAgPSB0cmFkZXMubGVuZ3RoID8gd2lucy90cmFkZXMubGVuZ3RoKjEwMCA6IDA7CiAgY29uc3Qgd2luU3VtICA9IHRyYWRlcy5maWx0ZXIodD0+dC5wbmw+MCkucmVkdWNlKChzLHQpPT5zK3QucG5sLDApOwogIGNvbnN0IGxvc3NTdW0gPSB0cmFkZXMuZmlsdGVyKHQ9PnQucG5sPD0wKS5yZWR1Y2UoKHMsdCk9PnMrdC5wbmwsMCk7CiAgY29uc3QgcGYgICAgICA9IGxvc3NTdW0/d2luU3VtL01hdGguYWJzKGxvc3NTdW0pOjA7CgogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3aW5QY3QiKS50ZXh0Q29udGVudCAgID0gd3IudG9GaXhlZCgwKSsiJSI7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndpbkNvdW50IikudGV4dENvbnRlbnQgID0gd2lucysiIHRyYWRlcyI7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImxvc3NDb3VudCIpLnRleHRDb250ZW50ID0gbG9zc2VzKyIgdHJhZGVzIjsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGZEaXNwbGF5IikudGV4dENvbnRlbnQgPSBwZi50b0ZpeGVkKDIpKyJ4IjsKCiAgaWYgKHdpbkNoYXJ0SW5zdCkgd2luQ2hhcnRJbnN0LmRlc3Ryb3koKTsKICBjb25zdCBjdHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2luQ2hhcnQiKS5nZXRDb250ZXh0KCIyZCIpOwogIHdpbkNoYXJ0SW5zdCA9IG5ldyBDaGFydChjdHgsIHsKICAgIHR5cGU6ICJkb3VnaG51dCIsCiAgICBkYXRhOiB7CiAgICAgIGRhdGFzZXRzOiBbewogICAgICAgIGRhdGE6IFt3aW5zfHwxLCBsb3NzZXN8fDFdLAogICAgICAgIGJhY2tncm91bmRDb2xvcjogWyIjMDBlNjc2IiwiI2ZmM2Q2YiJdLAogICAgICAgIGJvcmRlckNvbG9yOiAiIzExMTgyNyIsCiAgICAgICAgYm9yZGVyV2lkdGg6IDMsCiAgICAgICAgaG92ZXJPZmZzZXQ6IDQKICAgICAgfV0KICAgIH0sCiAgICBvcHRpb25zOiB7CiAgICAgIGN1dG91dDogIjcyJSIsCiAgICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICAgIHBsdWdpbnM6IHsgbGVnZW5kOiB7IGRpc3BsYXk6IGZhbHNlIH0sIHRvb2x0aXA6IHsgZW5hYmxlZDogZmFsc2UgfSB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlbmRlckRhaWx5Q2hhcnQoZGF0YSkgewogIGNvbnN0IHsgZGFpbHkgfSA9IGRhdGE7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRheXNCYWRnZSIpLnRleHRDb250ZW50ID0gZGFpbHkubGVuZ3RoKyIgZGF5cyI7CiAgaWYgKCFkYWlseS5sZW5ndGgpIHJldHVybjsKCiAgaWYgKGRhaWx5Q2hhcnRJbnN0KSBkYWlseUNoYXJ0SW5zdC5kZXN0cm95KCk7CiAgY29uc3QgY3R4ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhaWx5Q2hhcnQiKS5nZXRDb250ZXh0KCIyZCIpOwogIGRhaWx5Q2hhcnRJbnN0ID0gbmV3IENoYXJ0KGN0eCwgewogICAgdHlwZTogImJhciIsCiAgICBkYXRhOiB7CiAgICAgIGxhYmVsczogZGFpbHkubWFwKGQgPT4gewogICAgICAgIGNvbnN0IGR0ID0gbmV3IERhdGUoZC5kYXRlKTsKICAgICAgICByZXR1cm4gZHQudG9Mb2NhbGVEYXRlU3RyaW5nKCJlbi1JTiIse21vbnRoOiJzaG9ydCIsZGF5OiJudW1lcmljIn0pOwogICAgICB9KSwKICAgICAgZGF0YXNldHM6IFt7CiAgICAgICAgZGF0YTogZGFpbHkubWFwKGQ9PmQuZGFpbHlfcG5sKSwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGRhaWx5Lm1hcChkPT5kLmRhaWx5X3BubD49MD8icmdiYSgwLDIzMCwxMTgsMC43KSI6InJnYmEoMjU1LDYxLDEwNywwLjcpIiksCiAgICAgICAgYm9yZGVyQ29sb3I6ICAgICBkYWlseS5tYXAoZD0+ZC5kYWlseV9wbmw+PTA/IiMwMGU2NzYiOiIjZmYzZDZiIiksCiAgICAgICAgYm9yZGVyV2lkdGg6IDEsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA0LAogICAgICB9XQogICAgfSwKICAgIG9wdGlvbnM6IHsKICAgICAgcmVzcG9uc2l2ZTogdHJ1ZSwKICAgICAgcGx1Z2luczogeyBsZWdlbmQ6e2Rpc3BsYXk6ZmFsc2V9LCB0b29sdGlwOnsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IiMxMTE4MjciLCBib3JkZXJDb2xvcjoiIzFlMmQ0NSIsIGJvcmRlcldpZHRoOjEsCiAgICAgICAgdGl0bGVDb2xvcjoiIzY0NzQ4YiIsIGJvZHlDb2xvcjoiI2UyZThmMCIsCiAgICAgICAgY2FsbGJhY2tzOiB7IGxhYmVsOiBjdHggPT4gIiAgIisoY3R4LnJhdz49MD8iKyI6IiIpKyLigrkiK01hdGgucm91bmQoY3R4LnJhdykudG9Mb2NhbGVTdHJpbmcoImVuLUlOIikgfQogICAgICB9fSwKICAgICAgc2NhbGVzOiB7CiAgICAgICAgeDogeyBncmlkOntjb2xvcjoicmdiYSgzMCw0NSw2OSwwLjYpIn0sIHRpY2tzOntjb2xvcjoiIzY0NzQ4YiIsZm9udDp7ZmFtaWx5OiJKZXRCcmFpbnMgTW9ubyIsc2l6ZTo5fX0gfSwKICAgICAgICB5OiB7IGdyaWQ6e2NvbG9yOiJyZ2JhKDMwLDQ1LDY5LDAuNikifSwgdGlja3M6e2NvbG9yOiIjNjQ3NDhiIixmb250OntmYW1pbHk6IkpldEJyYWlucyBNb25vIixzaXplOjl9LAogICAgICAgICAgY2FsbGJhY2s6IHY9Pih2Pj0wPyIrIjoiIikrIuKCuSIrTWF0aC5yb3VuZCh2LzEwMDApKyJrIn0gfQogICAgICB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlbmRlckV4aXRCcmVha2Rvd24oZGF0YSkgewogIGNvbnN0IHsgdHJhZGVzIH0gPSBkYXRhOwogIGNvbnN0IGV4aXRDb2xvcnMgPSB7IFRQX1BSRU06IiMwMGU2NzYiLCBTTF9QUkVNOiIjZmYzZDZiIiwgVFJBSUw6IiNmZmQ3NjAiLCBFT0Q6IiM2NDc0OGIiLCBFTkQ6IiM2NDc0OGIiIH07CiAgY29uc3QgYnlSZWFzb24gPSB7fTsKICB0cmFkZXMuZm9yRWFjaCh0ID0+IHsKICAgIGlmICghYnlSZWFzb25bdC5yZWFzb25dKSBieVJlYXNvblt0LnJlYXNvbl0gPSB7IGNvdW50OjAsIHdpbnM6MCwgcG5sOjAgfTsKICAgIGJ5UmVhc29uW3QucmVhc29uXS5jb3VudCsrOwogICAgYnlSZWFzb25bdC5yZWFzb25dLnBubCArPSB0LnBubDsKICAgIGlmICh0LnBubCA+IDApIGJ5UmVhc29uW3QucmVhc29uXS53aW5zKys7CiAgfSk7CgogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJleGl0QnJlYWtkb3duIikuaW5uZXJIVE1MID0gT2JqZWN0LmVudHJpZXMoYnlSZWFzb24pLm1hcCgoW3IsZ10pPT5gCiAgICA8ZGl2IGNsYXNzPSJleGl0LXJvdyI+CiAgICAgIDxkaXYgY2xhc3M9ImV4aXQtbGFiZWwiPgogICAgICAgIDxkaXYgY2xhc3M9ImV4aXQtZG90IiBzdHlsZT0iYmFja2dyb3VuZDoke2V4aXRDb2xvcnNbcl18fCIjNjQ3NDhiIn0iPjwvZGl2PgogICAgICAgICR7cn0KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImV4aXQtc3RhdHMiPgogICAgICAgIDxkaXYgY2xhc3M9ImV4aXQtcG5sIiBzdHlsZT0iY29sb3I6JHtnLnBubD49MD8idmFyKC0tZ3JlZW4pIjoidmFyKC0tcmVkKSJ9Ij4ke2ZtdChnLnBubCl9PC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iY29sb3I6dmFyKC0tbXV0ZWQpO2ZvbnQtc2l6ZToxMHB4OyI+JHtnLmNvdW50fSB0cmFkZXMgwrcgJHsoZy53aW5zL2cuY291bnQqMTAwKS50b0ZpeGVkKDApfSUgV1I8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICBgKS5qb2luKCIiKSB8fCAnPGRpdiBjbGFzcz0iZW1wdHkiPjxkaXYgY2xhc3M9ImVtcHR5LWljb24iPvCfk608L2Rpdj5ObyB0cmFkZXMgeWV0PC9kaXY+JzsKfQoKZnVuY3Rpb24gcmVuZGVyU2lnbmFsTG9nKGRhdGEpIHsKICBjb25zdCB7IHNpZ25hbHMgfSA9IGRhdGE7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNpZ0JhZGdlIikudGV4dENvbnRlbnQgPSBzaWduYWxzLmxlbmd0aCsiIHNpZ25hbHMiOwogIGNvbnN0IHNvcnRlZCA9IFsuLi5zaWduYWxzXS5zb3J0KChhLGIpPT5uZXcgRGF0ZShiLmRhdGV0aW1lKS1uZXcgRGF0ZShhLmRhdGV0aW1lKSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNpZ25hbExvZyIpLmlubmVySFRNTCA9IHNvcnRlZC5zbGljZSgwLDMwKS5tYXAocz0+ewogICAgY29uc3QgZCA9IG5ldyBEYXRlKHMuZGF0ZXRpbWUpOwogICAgY29uc3QgdGltZSA9IGQudG9Mb2NhbGVEYXRlU3RyaW5nKCJlbi1JTiIse21vbnRoOiJzaG9ydCIsZGF5OiJudW1lcmljIn0pKyIgIisKICAgICAgICAgICAgICAgICBkLnRvTG9jYWxlVGltZVN0cmluZygiZW4tSU4iLHtob3VyOiIyLWRpZ2l0IixtaW51dGU6IjItZGlnaXQifSk7CiAgICByZXR1cm4gYAogICAgICA8ZGl2IGNsYXNzPSJzaWduYWwtcm93Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJzaWduYWwtdGltZSI+JHt0aW1lfTwvZGl2PgogICAgICAgIDxzcGFuIGNsYXNzPSJiYWRnZSAke3MuZGlyZWN0aW9uPT09IkNFIj8iYmFkZ2UtY2UiOiJiYWRnZS1wZSJ9Ij4ke3MuZGlyZWN0aW9ufTwvc3Bhbj4KICAgICAgICA8ZGl2IGNsYXNzPSJzaWduYWwtc3BvdCI+4oK5JHtNYXRoLnJvdW5kKHMuc3BvdCkudG9Mb2NhbGVTdHJpbmcoImVuLUlOIil9PC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEwcHg7Y29sb3I6dmFyKC0tbXV0ZWQpIj5BRFggJHtzLmFkeC50b0ZpeGVkKDApfSBSU0kgJHtzLnJzaS50b0ZpeGVkKDApfTwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OmF1dG87Zm9udC1zaXplOjEwcHg7Y29sb3I6JHtzLmFjdGVkX29uPyJ2YXIoLS1ncmVlbikiOiJ2YXIoLS1tdXRlZCkifSI+JHtzLmFjdGVkX29uPyLinIUgVHJhZGVkIjoi4oCUIFNraXBwZWQifTwvZGl2PgogICAgICA8L2Rpdj4KICAgIGA7CiAgfSkuam9pbigiIikgfHwgJzxkaXYgY2xhc3M9ImVtcHR5Ij48ZGl2IGNsYXNzPSJlbXB0eS1pY29uIj7wn5OtPC9kaXY+Tm8gc2lnbmFscyB5ZXQ8L2Rpdj4nOwp9CgpmdW5jdGlvbiByZW5kZXJUcmFkZVRhYmxlKGRhdGEpIHsKICBjb25zdCB7IHRyYWRlcyB9ID0gZGF0YTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidHJhZGVCYWRnZSIpLnRleHRDb250ZW50ID0gdHJhZGVzLmxlbmd0aCsiIHRyYWRlcyI7CiAgY29uc3Qgc29ydGVkID0gWy4uLnRyYWRlc10uc29ydCgoYSxiKT0+bmV3IERhdGUoYi5lbnRyeV90aW1lKS1uZXcgRGF0ZShhLmVudHJ5X3RpbWUpKTsKCiAgaWYgKCFzb3J0ZWQubGVuZ3RoKSB7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidHJhZGVUYWJsZUJvZHkiKS5pbm5lckhUTUwgPSAiIjsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0cmFkZUVtcHR5Iikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICByZXR1cm47CiAgfQogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0cmFkZUVtcHR5Iikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCiAgY29uc3QgYmFkZ2VSZWFzb24gPSByID0+IHsKICAgIGNvbnN0IG1hcCA9IHsgVFBfUFJFTToiYmFkZ2UtdHAiLCBTTF9QUkVNOiJiYWRnZS1zbCIsIFRSQUlMOiJiYWRnZS10ciIsIEVPRDoiYmFkZ2UtZW9kIiwgRU5EOiJiYWRnZS1lb2QiIH07CiAgICByZXR1cm4gYDxzcGFuIGNsYXNzPSJiYWRnZSAke21hcFtyXXx8ImJhZGdlLWVvZCJ9Ij4ke3J9PC9zcGFuPmA7CiAgfTsKCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInRyYWRlVGFibGVCb2R5IikuaW5uZXJIVE1MID0gc29ydGVkLm1hcCh0PT57CiAgICBjb25zdCBldCA9IG5ldyBEYXRlKHQuZW50cnlfdGltZSk7CiAgICBjb25zdCB4dCA9IG5ldyBEYXRlKHQuZXhpdF90aW1lKTsKICAgIGNvbnN0IGV0cyA9IGV0LnRvTG9jYWxlRGF0ZVN0cmluZygiZW4tSU4iLHttb250aDoic2hvcnQiLGRheToibnVtZXJpYyJ9KSsiICIrZXQudG9Mb2NhbGVUaW1lU3RyaW5nKCJlbi1JTiIse2hvdXI6IjItZGlnaXQiLG1pbnV0ZToiMi1kaWdpdCJ9KTsKICAgIGNvbnN0IHh0cyA9IHh0LnRvTG9jYWxlRGF0ZVN0cmluZygiZW4tSU4iLHttb250aDoic2hvcnQiLGRheToibnVtZXJpYyJ9KSsiICIreHQudG9Mb2NhbGVUaW1lU3RyaW5nKCJlbi1JTiIse2hvdXI6IjItZGlnaXQiLG1pbnV0ZToiMi1kaWdpdCJ9KTsKICAgIGNvbnN0IHBubENsciA9IHQucG5sPj0wPyJ2YXIoLS1ncmVlbikiOiJ2YXIoLS1yZWQpIjsKICAgIHJldHVybiBgCiAgICAgIDx0cj4KICAgICAgICA8dGQgc3R5bGU9ImNvbG9yOnZhcigtLW11dGVkKSI+IyR7dC5pZH08L3RkPgogICAgICAgIDx0ZD5VJHt0LnVuaXR9PC90ZD4KICAgICAgICA8dGQ+PHNwYW4gY2xhc3M9ImJhZGdlICR7dC5vcHRfdHlwZT09PSJDRSI/ImJhZGdlLWNlIjoiYmFkZ2UtcGUifSI+JHt0Lm9wdF90eXBlfTwvc3Bhbj48L3RkPgogICAgICAgIDx0ZCBzdHlsZT0iY29sb3I6dmFyKC0tbXV0ZWQpO2ZvbnQtc2l6ZToxMXB4Ij4ke3Quc3ltYm9sfTwvdGQ+CiAgICAgICAgPHRkPuKCuSR7dC5zdHJpa2V9PC90ZD4KICAgICAgICA8dGQgc3R5bGU9ImNvbG9yOnZhcigtLW11dGVkKSI+JHtldHN9PC90ZD4KICAgICAgICA8dGQgc3R5bGU9ImNvbG9yOnZhcigtLW11dGVkKSI+JHt4dHN9PC90ZD4KICAgICAgICA8dGQ+4oK5JHt0LmVudHJ5X3ByZW0udG9GaXhlZCgxKX08L3RkPgogICAgICAgIDx0ZD7igrkke3QuZXhpdF9wcmVtLnRvRml4ZWQoMSl9PC90ZD4KICAgICAgICA8dGQ+JHt0LnF0eX08L3RkPgogICAgICAgIDx0ZCBzdHlsZT0iY29sb3I6JHtwbmxDbHJ9O2ZvbnQtd2VpZ2h0OjYwMCI+JHt0LnBubD49MD8iKyI6IiJ94oK5JHtNYXRoLnJvdW5kKHQucG5sKS50b0xvY2FsZVN0cmluZygiZW4tSU4iKX08L3RkPgogICAgICAgIDx0ZCBzdHlsZT0iY29sb3I6dmFyKC0tbXV0ZWQpIj4ke3QuYmFyc19oZWxkfTwvdGQ+CiAgICAgICAgPHRkPiR7YmFkZ2VSZWFzb24odC5yZWFzb24pfTwvdGQ+CiAgICAgIDwvdHI+CiAgICBgOwogIH0pLmpvaW4oIiIpOwp9CgovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKLy8gTUFJTiBMT0FEIEZVTkNUSU9OCi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAoKYXN5bmMgZnVuY3Rpb24gbG9hZERhdGEoKSB7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImxhc3RVcGRhdGUiKS50ZXh0Q29udGVudCA9CiAgICAiVXBkYXRlZDogIituZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygiZW4tSU4iKTsKCiAgbGV0IGRhdGE7CiAgdHJ5IHsKICAgIC8vIFRyeSB0byBmZXRjaCBmcm9tIGxvY2FsIEFQSSAoZGFzaGJvYXJkX2FwaS5weSkKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKCIvYXBpL2Rhc2hib2FyZCIpOwogICAgaWYgKHJlcy5vaykgewogICAgICBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQVBJIG5vdCBhdmFpbGFibGUiKTsKICAgIH0KICB9IGNhdGNoKGUpIHsKICAgIC8vIEZhbGxiYWNrIHRvIGRlbW8gZGF0YQogICAgY29uc29sZS5sb2coIlVzaW5nIGRlbW8gZGF0YSDigJQgY29ubmVjdCBkYXNoYm9hcmRfYXBpLnB5IGZvciBsaXZlIGRhdGEiKTsKICAgIGRhdGEgPSBnZW5lcmF0ZURlbW9EYXRhKCk7CiAgfQoKICByZW5kZXJLUElzKGRhdGEpOwogIHJlbmRlclVuaXRzKGRhdGEpOwogIHJlbmRlckVxdWl0eUNoYXJ0KGRhdGEpOwogIHJlbmRlcldpbkNoYXJ0KGRhdGEpOwogIHJlbmRlckRhaWx5Q2hhcnQoZGF0YSk7CiAgcmVuZGVyRXhpdEJyZWFrZG93bihkYXRhKTsKICByZW5kZXJTaWduYWxMb2coZGF0YSk7CiAgcmVuZGVyVHJhZGVUYWJsZShkYXRhKTsKfQoKLy8gQXV0byByZWZyZXNoIGV2ZXJ5IDUgbWludXRlcwpsb2FkRGF0YSgpOwpzZXRJbnRlcnZhbChsb2FkRGF0YSwgNSAqIDYwICogMTAwMCk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K"
DASHBOARD_HTML = base64.b64decode(_HTML_B64).decode()

TOKEN_PAGE = """<!DOCTYPE html>
<html><head><title>Update Token</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#080c14;color:#e2e8f0;font-family:monospace;
     display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.card{background:#111827;border:1px solid #1e2d45;border-radius:16px;padding:32px;width:100%;max-width:500px}
h2{color:#00d4ff;margin-bottom:8px;font-size:18px}
p{color:#64748b;font-size:12px;margin-bottom:24px}
label{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:8px}
textarea{width:100%;background:#0d1420;border:1px solid #1e2d45;border-radius:8px;
         color:#e2e8f0;font-family:monospace;font-size:11px;padding:12px;
         resize:vertical;min-height:120px;margin-bottom:16px}
textarea:focus{outline:none;border-color:#00d4ff}
button{width:100%;background:#00d4ff;color:#080c14;border:none;border-radius:8px;
       padding:14px;font-family:monospace;font-size:13px;font-weight:700;cursor:pointer}
.steps{background:#0d1420;border-radius:8px;padding:16px;margin-bottom:24px;font-size:11px;color:#64748b}
.steps li{margin:6px 0}
.steps strong{color:#e2e8f0}
.msg{margin-top:16px;padding:12px;border-radius:8px;font-size:12px;text-align:center;display:none}
.ok{background:rgba(0,230,118,0.1);color:#00e676;border:1px solid rgba(0,230,118,0.2)}
.er{background:rgba(255,61,107,0.1);color:#ff3d6b;border:1px solid rgba(255,61,107,0.2)}
</style></head>
<body><div class="card">
<h2>üîë Update Dhan Token</h2>
<p>Paste your new Dhan token every morning ‚Äî takes 10 seconds.</p>
<div class="steps"><strong>How to get new token:</strong>
<ol style="padding-left:16px;margin-top:8px">
<li>Login to <strong>dhan.co</strong></li>
<li>Go to <strong>My Profile ‚Üí API Access</strong></li>
<li>Click <strong>Generate Token</strong></li>
<li>Copy & paste below üëá</li>
</ol></div>
<label>New Dhan Access Token</label>
<textarea id="tok" placeholder="Paste your full token here..."></textarea>
<button onclick="go()">‚ö° Update Token Now</button>
<div class="msg ok" id="ok">‚úÖ Token updated! Bot will use new token within 1 minute.</div>
<div class="msg er" id="er">‚ùå Error updating token.</div>
</div>
<script>
async function go(){
  const t=document.getElementById('tok').value.trim();
  if(!t){alert('Paste your token first!');return;}
  document.querySelector('button').textContent='Updating...';
  try{
    const r=await fetch('/api/update-token',{method:'POST',
      headers:{'Content-Type':'application/json'},body:JSON.stringify({token:t})});
    const d=await r.json();
    if(d.success){document.getElementById('ok').style.display='block';
                  document.getElementById('er').style.display='none';}
    else throw new Error(d.error);
  }catch(e){
    document.getElementById('er').style.display='block';
    document.getElementById('ok').style.display='none';
  }
  document.querySelector('button').textContent='‚ö° Update Token Now';
}
</script></body></html>"""


def query(sql, args=()):
    if not os.path.exists(DB_FILE):
        return []
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    rows = conn.execute(sql, args).fetchall()
    conn.close()
    return [dict(r) for r in rows]


@app.route("/")
def index():
    return Response(DASHBOARD_HTML, mimetype="text/html")


@app.route("/update-token")
def token_page():
    return Response(TOKEN_PAGE, mimetype="text/html")


@app.route("/api/update-token", methods=["POST"])
def update_token():
    data      = request.get_json()
    new_token = (data.get("token") or "").strip()
    if not new_token:
        return jsonify({"success": False, "error": "No token provided"})

    # Write to a shared token file that bot.py reads
    token_file = str(BASE_DIR / "dhan_token.txt")
    with open(token_file, "w") as f:
        f.write(new_token)

    return jsonify({"success": True})


@app.route("/api/dashboard")
def dashboard():
    trades    = query("SELECT * FROM trades ORDER BY entry_time DESC")
    daily     = query("SELECT * FROM daily_summary ORDER BY date")
    signals   = query("SELECT * FROM signals ORDER BY datetime DESC LIMIT 50")
    unit_rows = query("SELECT unit as uid, SUM(pnl) as pnl, COUNT(*) as trades FROM trades GROUP BY unit")

    unit_stats = []
    if os.path.exists(STATE_F):
        with open(STATE_F) as f:
            state = json.load(f)
        for u in state["units"]:
            matched = next((r for r in unit_rows if r["uid"] == u["uid"]), None)
            unit_stats.append({"uid": u["uid"], "capital": u["capital"],
                                "pnl": u["capital"] - 20000,
                                "trades": matched["trades"] if matched else 0})
    else:
        for i in range(5):
            matched = next((r for r in unit_rows if r["uid"] == i), None)
            unit_stats.append({"uid": i,
                                "capital": 20000 + (matched["pnl"] if matched else 0),
                                "pnl":     matched["pnl"] if matched else 0,
                                "trades":  matched["trades"] if matched else 0})

    equity = []
    eq = 100000
    for t in sorted(trades, key=lambda x: x["exit_time"] or ""):
        eq += t["pnl"]
        equity.append({"ts": t["exit_time"], "eq": eq})

    return jsonify({"trades": trades, "daily": daily, "signals": signals,
                    "unitStats": unit_stats, "equity": equity})


if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)
